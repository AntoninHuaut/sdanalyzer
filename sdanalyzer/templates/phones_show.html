{% extends "layout.html" %}
{% block content %}
<div class="jumbotron">
    <h1>Phone: {{phone.name}}</h1>
            <table class="table" class="display hover compact table table-striped table-bordered" id="table1" style="width: 100%">
                <thead>
                <tr>
                    <th>Package Name</th>
                    <th>App Name</th>
                    <th>Cert</th>
                    <th>Perms</th>
                    <th>VT</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for p in apks %}
                <tr>
                    <td><a href="/apk/{{p.id}}">{{p.package_name}}</a></td>
                    <td>{{p.app_name}}</td>
                    <td><small>{{p.certificate_sha1}}</small>{% if p.certificate_trusted%} <i class="fa fa-check-circle text-success"></i> {%endif%}</td>
                    <td>{{p.permissions_suspicious}}</td>
                    <td>{% if p.vt_link %}<a href="{{p.vt_link}}" target="_blank">{{p.vt_positives}} / {{p.vt_total}}</a>{% else %}Unknown{%endif %}</td>
                    <td>{% if p.suspicious_level == 1%}<span class="badge badge-success">Low</span>{%elif p.suspicious_level == 2%}<span class="badge badge-warning">Medium</span>{%else%}<span class="badge badge-danger">High</span>{% endif %}</td>
                    <td><span id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{% if p.suspicious == False %}<i class="fa fa-thumbs-up"></i>{%elif p.suspicious == True %}<i class="fa fa-thumbs-down"></i>{% else %}<i class="fa fa-question"></i>{% endif %}</span><div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="/apk/{{p.id}}/status?status=good&next=phone"><i class="fa fa-thumbs-up"></i></a>
                            <a class="dropdown-item" href="/apk/{{p.id}}/status?status=none&next=phone"><i class="fa fa-question"></i></a>
    <a class="dropdown-item" href="/apk/{{p.id}}/status?status=bad&next=phone"><i class="fa fa-thumbs-down"></i></a>
  </div></td>
                    <td>{{p.id}}</td>
                    <td>{{p.suspicious}}</td>
                    <td>{{p.suspicious_level}}</td>
                    <td>{{p.certificate_trusted}}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
</div>
{% endblock %}
{% block scripts %}
    <script>
$(function(){
    var table = $('#table1').DataTable({
        "paging":   false,
        "order": [[ 9, "desc" ]],
        "columnDefs": [
            {
                "targets": [ 0],
                "width": "30%"
            },
            {
                "targets": [ 1],
                "width": "15%"
            },
            {
                "targets": [ 2],
                "width": "320px"
            },
            {
                "targets": [ 3],
                "width": "50px"
            },
            {
                "targets": [ 4],
                "width": "80px"
            },
            {
                "targets": [ 5],
                "width": "60px"
            },
            {
                "targets": [ 6],
                "width": "15px"
            },
            {
                "targets": [ 7 ],
                "visible": false,
                "searchable": false
            },
            {
                "targets": [ 8 ],
                "visible": false,
            },
            {
                "targets": [ 9 ],
                "visible": false,
            },
            {
                "targets": [ 10 ],
                "visible": false,
            }
        ],
        "dom": 'Bfrtip',
        "buttons": [
            {
                text: 'Mark All Shown As Good',
                action: function ( e, dt, node, config ) {
                    data = table.rows({ search: 'applied' }).data();
                    apks = Array.from(data, x => x[7]);
                    if (apks.length > 0) {
                        d = JSON.stringify({'status': 'good', 'apks': apks});
                        $.ajax({
                            type: "POST",
                            contentType: "application/json; charset=utf-8",
                            url: "/apk/bulk_status",
                            data: d,
                            dataType: "json",
                            success: function (data, st, xhr) {
                                document.location.reload(true);
                            }
                        });
                    }
                }
            },
            {
                text: 'Hide Analyzed Apps',
                action: function ( e, dt, node, config ) {
                    table
                    .column(8)
                    .search('None')
                    .draw();
                }
            },
            {
                text: 'Hide Apps with Trusted Certs',
                action: function ( e, dt, node, config ) {
                    table
                    .column(10)
                    .search('False')
                    .draw();
                }
            },
            {
                text: 'Show All',
                action: function ( e, dt, node, config ) {
                    table
                    .search( '' )
                    .columns().search( '' )
                    .draw();
                }
            }
        ]
    });
} );
    </script>
{% endblock %}
